# WakaTime Telegram Bot

Телеграм-бот для отслеживания времени кодинга команды с помощью WakaTime API.

## Функции

- Регистрация пользователей с WakaTime API ключами
- Отображение рейтинга участников по времени кодинга
- Поддержка разных временных периодов: день, неделя, месяц, год
- Кэширование данных для быстрого отклика

## Команды бота

- `/start`, `/register` - начать процесс регистрации
- `/setkey` - изменить API ключ
- `/top` - показать рейтинг за день
- `/week` - показать рейтинг за неделю
- `/month` - показать рейтинг за месяц
- `/year` - показать рейтинг за год
- `/help` - показать список команд

## Архитектура

- **db.py** - взаимодействие с базой данных PostgreSQL
- **wakatime_client.py** - получение данных из WakaTime API
- **redis_cache.py** - кэширование для `month` и `year` статистики
- **handlers/** - обработчики команд бота
- **update_month_cache.py**, **update_year_cache.py** - скрипты обновления кэша

## Запуск

### Переменные окружения (в .env файле)

```
API_TOKEN=ваш_токен_от_BotFather
DATABASE_URL=postgresql://some_nic_admin:123@db:5432/nicwaka
REDIS_URL=redis://redis:6379/0
```

### Запуск через Docker Compose

```bash
docker-compose up -d
```

## Отладка и обновление кэша

Для ручного обновления кэша можно использовать:

```bash
# Запуск скрипта ручного обновления кэша
docker-compose exec bot python update_cache_manual.py

# Просмотр логов обновления кэша
docker-compose logs scheduler

# Просмотр логов бота
docker-compose logs bot
```

## Архитектура кэширования

- Статистика за месяц обновляется каждый час
- Статистика за год обновляется в 00:00 каждый день
- Управление планировщиком задач осуществляется через Supervisor
- Для просмотра и отладки логов: `docker-compose logs scheduler`
